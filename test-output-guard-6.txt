[31m[Nest] 19260  - [39m21.02.2026, 12:33:45 [31m  ERROR[39m [38;5;3m[ApiKeyGuard] [39m[31mAuthentication error:[39m
[31m[Nest] 19260  - [39m21.02.2026, 12:33:45 [31m  ERROR[39m [38;5;3m[ApiKeyGuard] [39m[31mTypeError: Cannot read properties of undefined (reading 'length')[39m
FAIL src/common/guards/api-key.guard.spec.ts (14.397 s)
  ApiKeyGuard
    âˆš should throw UnauthorizedException if no API key is provided (57 ms)
    âˆš should throw UnauthorizedException if API key is invalid (7 ms)
    Ã— should allow request and update balance atomically (15 ms)
    Ã— should throw ForbiddenException if account is suspended (26 ms)

  â— ApiKeyGuard â€º should allow request and update balance atomically

    UnauthorizedException: Failed to authenticate API key

    [0m [90m 325 |[39m
     [90m 326 |[39m             [36mthis[39m[33m.[39mlogger[33m.[39merror([32m'Authentication error:'[39m[33m,[39m error)[33m;[39m
    [31m[1m>[22m[39m[90m 327 |[39m             [36mthrow[39m [36mnew[39m [33mUnauthorizedException[39m({
     [90m     |[39m                   [31m[1m^[22m[39m
     [90m 328 |[39m                 statusCode[33m:[39m [35m401[39m[33m,[39m
     [90m 329 |[39m                 error[33m:[39m [32m'AUTHENTICATION_FAILED'[39m[33m,[39m
     [90m 330 |[39m                 message[33m:[39m [32m'Failed to authenticate API key'[39m[33m,[39m[0m

      at ApiKeyGuard.canActivate (common/guards/api-key.guard.ts:327:19)
      at Object.<anonymous> (common/guards/api-key.guard.spec.ts:134:24)

  â— ApiKeyGuard â€º should throw ForbiddenException if account is suspended

    expect(received).rejects.toThrow(expected)

    Expected constructor: ForbiddenException
    Received constructor: UnauthorizedException

    Received message: "Associated user account not found"

        [0m [90m 100 |[39m             [36mconst[39m user [33m=[39m dbKey[33m.[39muser[33m;[39m
         [90m 101 |[39m             [36mif[39m ([33m![39muser) {
        [31m[1m>[22m[39m[90m 102 |[39m                 [36mthrow[39m [36mnew[39m [33mUnauthorizedException[39m({
         [90m     |[39m                       [31m[1m^[22m[39m
         [90m 103 |[39m                     statusCode[33m:[39m [35m401[39m[33m,[39m
         [90m 104 |[39m                     error[33m:[39m [32m'USER_NOT_FOUND'[39m[33m,[39m
         [90m 105 |[39m                     message[33m:[39m [32m'Associated user account not found'[39m[33m,[39m[0m

      at ApiKeyGuard.canActivate (common/guards/api-key.guard.ts:102:23)
      at Object.<anonymous> (common/guards/api-key.guard.spec.ts:161:9)
      at Object.toThrow (../node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (common/guards/api-key.guard.spec.ts:161:58)

Test Suites: 1 failed, 1 total
Tests:       2 failed, 2 passed, 4 total
Snapshots:   0 total
Time:        15.026 s
Ran all test suites matching /src\\common\\guards\\api-key.guard.spec.ts/i.
