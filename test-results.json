[31m[Nest] 6012  - [39m21.02.2026, 12:35:00 [31m  ERROR[39m [38;5;3m[ApiKeyGuard] [39m[31mAuthentication error:[39m
[31m[Nest] 6012  - [39m21.02.2026, 12:35:00 [31m  ERROR[39m [38;5;3m[ApiKeyGuard] [39m[31mTypeError: Cannot read properties of undefined (reading 'length')[39m
FAIL src/common/guards/api-key.guard.spec.ts (13.402 s)
  ApiKeyGuard
    âˆš should throw UnauthorizedException if no API key is provided (79 ms)
    âˆš should throw UnauthorizedException if API key is invalid (8 ms)
    Ã— should allow request and update balance atomically (15 ms)
    Ã— should throw ForbiddenException if account is suspended (32 ms)

  â— ApiKeyGuard â€º should allow request and update balance atomically

    UnauthorizedException: Failed to authenticate API key

    [0m [90m 325 |[39m
     [90m 326 |[39m             [36mthis[39m[33m.[39mlogger[33m.[39merror([32m'Authentication error:'[39m[33m,[39m error)[33m;[39m
    [31m[1m>[22m[39m[90m 327 |[39m             [36mthrow[39m [36mnew[39m [33mUnauthorizedException[39m({
     [90m     |[39m                   [31m[1m^[22m[39m
     [90m 328 |[39m                 statusCode[33m:[39m [35m401[39m[33m,[39m
     [90m 329 |[39m                 error[33m:[39m [32m'AUTHENTICATION_FAILED'[39m[33m,[39m
     [90m 330 |[39m                 message[33m:[39m [32m'Failed to authenticate API key'[39m[33m,[39m[0m

      at ApiKeyGuard.canActivate (common/guards/api-key.guard.ts:327:19)
      at Object.<anonymous> (common/guards/api-key.guard.spec.ts:134:24)

  â— ApiKeyGuard â€º should throw ForbiddenException if account is suspended

    expect(received).rejects.toThrow(expected)

    Expected constructor: ForbiddenException
    Received constructor: UnauthorizedException

    Received message: "Associated user account not found"

        [0m [90m 100 |[39m             [36mconst[39m user [33m=[39m dbKey[33m.[39muser[33m;[39m
         [90m 101 |[39m             [36mif[39m ([33m![39muser) {
        [31m[1m>[22m[39m[90m 102 |[39m                 [36mthrow[39m [36mnew[39m [33mUnauthorizedException[39m({
         [90m     |[39m                       [31m[1m^[22m[39m
         [90m 103 |[39m                     statusCode[33m:[39m [35m401[39m[33m,[39m
         [90m 104 |[39m                     error[33m:[39m [32m'USER_NOT_FOUND'[39m[33m,[39m
         [90m 105 |[39m                     message[33m:[39m [32m'Associated user account not found'[39m[33m,[39m[0m

      at ApiKeyGuard.canActivate (common/guards/api-key.guard.ts:102:23)
      at Object.<anonymous> (common/guards/api-key.guard.spec.ts:161:9)
      at Object.toThrow (../node_modules/expect/build/index.js:218:22)
      at Object.<anonymous> (common/guards/api-key.guard.spec.ts:161:58)

Test Suites: 1 failed, 1 total
Tests:       2 failed, 2 passed, 4 total
Snapshots:   0 total
Time:        13.943 s
Ran all test suites matching /src\\common\\guards\\api-key.guard.spec.ts/i.
{"numFailedTestSuites":1,"numFailedTests":2,"numPassedTestSuites":0,"numPassedTests":2,"numPendingTestSuites":0,"numPendingTests":0,"numRuntimeErrorTestSuites":0,"numTodoTests":0,"numTotalTestSuites":1,"numTotalTests":4,"openHandles":[],"snapshot":{"added":0,"didUpdate":false,"failure":false,"filesAdded":0,"filesRemoved":0,"filesRemovedList":[],"filesUnmatched":0,"filesUpdated":0,"matched":0,"total":0,"unchecked":0,"uncheckedKeysByFile":[],"unmatched":0,"updated":0},"startTime":1771659286417,"success":false,"testResults":[{"assertionResults":[{"ancestorTitles":["ApiKeyGuard"],"duration":79,"failureDetails":[],"failureMessages":[],"fullName":"ApiKeyGuard should throw UnauthorizedException if no API key is provided","invocations":1,"location":null,"numPassingAsserts":1,"retryReasons":[],"status":"passed","title":"should throw UnauthorizedException if no API key is provided"},{"ancestorTitles":["ApiKeyGuard"],"duration":8,"failureDetails":[],"failureMessages":[],"fullName":"ApiKeyGuard should throw UnauthorizedException if API key is invalid","invocations":1,"location":null,"numPassingAsserts":1,"retryReasons":[],"status":"passed","title":"should throw UnauthorizedException if API key is invalid"},{"ancestorTitles":["ApiKeyGuard"],"duration":15,"failureDetails":[{"response":{"statusCode":401,"error":"AUTHENTICATION_FAILED","message":"Failed to authenticate API key"},"status":401,"options":{},"message":"Failed to authenticate API key","name":"UnauthorizedException"}],"failureMessages":["UnauthorizedException: Failed to authenticate API key\n    at ApiKeyGuard.canActivate (C:\\Users\\Intel\\Desktop\\mumin\\api\\src\\common\\guards\\api-key.guard.ts:327:19)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at Object.<anonymous> (C:\\Users\\Intel\\Desktop\\mumin\\api\\src\\common\\guards\\api-key.guard.spec.ts:134:24)"],"fullName":"ApiKeyGuard should allow request and update balance atomically","invocations":1,"location":null,"numPassingAsserts":0,"retryReasons":[],"status":"failed","title":"should allow request and update balance atomically"},{"ancestorTitles":["ApiKeyGuard"],"duration":32,"failureDetails":[{"matcherResult":{"message":"expect(received).rejects.toThrow(expected)\n\nExpected constructor: ForbiddenException\nReceived constructor: UnauthorizedException\n\nReceived message: \"Associated user account not found\"\n\n    \u001b[0m \u001b[90m 100 |\u001b[39m             \u001b[36mconst\u001b[39m user \u001b[33m=\u001b[39m dbKey\u001b[33m.\u001b[39muser\u001b[33m;\u001b[39m\n     \u001b[90m 101 |\u001b[39m             \u001b[36mif\u001b[39m (\u001b[33m!\u001b[39muser) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 102 |\u001b[39m                 \u001b[36mthrow\u001b[39m \u001b[36mnew\u001b[39m \u001b[33mUnauthorizedException\u001b[39m({\n     \u001b[90m     |\u001b[39m                       \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 103 |\u001b[39m                     statusCode\u001b[33m:\u001b[39m \u001b[35m401\u001b[39m\u001b[33m,\u001b[39m\n     \u001b[90m 104 |\u001b[39m                     error\u001b[33m:\u001b[39m \u001b[32m'USER_NOT_FOUND'\u001b[39m\u001b[33m,\u001b[39m\n     \u001b[90m 105 |\u001b[39m                     message\u001b[33m:\u001b[39m \u001b[32m'Associated user account not found'\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\n\n      at ApiKeyGuard.canActivate (src/common/guards/api-key.guard.ts:102:23)\n      at Object.<anonymous> (src/common/guards/api-key.guard.spec.ts:161:9)","pass":false},"message":"expect(received).rejects.toThrow(expected)\n\nExpected constructor: ForbiddenException\nReceived constructor: UnauthorizedException\n\nReceived message: \"Associated user account not found\"\n\n    \u001b[0m \u001b[90m 100 |\u001b[39m             \u001b[36mconst\u001b[39m user \u001b[33m=\u001b[39m dbKey\u001b[33m.\u001b[39muser\u001b[33m;\u001b[39m\n     \u001b[90m 101 |\u001b[39m             \u001b[36mif\u001b[39m (\u001b[33m!\u001b[39muser) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 102 |\u001b[39m                 \u001b[36mthrow\u001b[39m \u001b[36mnew\u001b[39m \u001b[33mUnauthorizedException\u001b[39m({\n     \u001b[90m     |\u001b[39m                       \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 103 |\u001b[39m                     statusCode\u001b[33m:\u001b[39m \u001b[35m401\u001b[39m\u001b[33m,\u001b[39m\n     \u001b[90m 104 |\u001b[39m                     error\u001b[33m:\u001b[39m \u001b[32m'USER_NOT_FOUND'\u001b[39m\u001b[33m,\u001b[39m\n     \u001b[90m 105 |\u001b[39m                     message\u001b[33m:\u001b[39m \u001b[32m'Associated user account not found'\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\n\n      at ApiKeyGuard.canActivate (src/common/guards/api-key.guard.ts:102:23)\n      at Object.<anonymous> (src/common/guards/api-key.guard.spec.ts:161:9)"}],"failureMessages":["Error: expect(received).rejects.toThrow(expected)\n\nExpected constructor: ForbiddenException\nReceived constructor: UnauthorizedException\n\nReceived message: \"Associated user account not found\"\n\n    \u001b[0m \u001b[90m 100 |\u001b[39m             \u001b[36mconst\u001b[39m user \u001b[33m=\u001b[39m dbKey\u001b[33m.\u001b[39muser\u001b[33m;\u001b[39m\n     \u001b[90m 101 |\u001b[39m             \u001b[36mif\u001b[39m (\u001b[33m!\u001b[39muser) {\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 102 |\u001b[39m                 \u001b[36mthrow\u001b[39m \u001b[36mnew\u001b[39m \u001b[33mUnauthorizedException\u001b[39m({\n     \u001b[90m     |\u001b[39m                       \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 103 |\u001b[39m                     statusCode\u001b[33m:\u001b[39m \u001b[35m401\u001b[39m\u001b[33m,\u001b[39m\n     \u001b[90m 104 |\u001b[39m                     error\u001b[33m:\u001b[39m \u001b[32m'USER_NOT_FOUND'\u001b[39m\u001b[33m,\u001b[39m\n     \u001b[90m 105 |\u001b[39m                     message\u001b[33m:\u001b[39m \u001b[32m'Associated user account not found'\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\n\n      at ApiKeyGuard.canActivate (src/common/guards/api-key.guard.ts:102:23)\n      at Object.<anonymous> (src/common/guards/api-key.guard.spec.ts:161:9)\n    at Object.toThrow (C:\\Users\\Intel\\Desktop\\mumin\\api\\node_modules\\expect\\build\\index.js:218:22)\n    at Object.<anonymous> (C:\\Users\\Intel\\Desktop\\mumin\\api\\src\\common\\guards\\api-key.guard.spec.ts:161:58)\n    at Promise.then.completed (C:\\Users\\Intel\\Desktop\\mumin\\api\\node_modules\\jest-circus\\build\\utils.js:298:28)\n    at new Promise (<anonymous>)\n    at callAsyncCircusFn (C:\\Users\\Intel\\Desktop\\mumin\\api\\node_modules\\jest-circus\\build\\utils.js:231:10)\n    at _callCircusTest (C:\\Users\\Intel\\Desktop\\mumin\\api\\node_modules\\jest-circus\\build\\run.js:316:40)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at _runTest (C:\\Users\\Intel\\Desktop\\mumin\\api\\node_modules\\jest-circus\\build\\run.js:252:3)\n    at _runTestsForDescribeBlock (C:\\Users\\Intel\\Desktop\\mumin\\api\\node_modules\\jest-circus\\build\\run.js:126:9)\n    at _runTestsForDescribeBlock (C:\\Users\\Intel\\Desktop\\mumin\\api\\node_modules\\jest-circus\\build\\run.js:121:9)\n    at run (C:\\Users\\Intel\\Desktop\\mumin\\api\\node_modules\\jest-circus\\build\\run.js:71:3)\n    at runAndTransformResultsToJestFormat (C:\\Users\\Intel\\Desktop\\mumin\\api\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n    at jestAdapter (C:\\Users\\Intel\\Desktop\\mumin\\api\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n    at runTestInternal (C:\\Users\\Intel\\Desktop\\mumin\\api\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n    at runTest (C:\\Users\\Intel\\Desktop\\mumin\\api\\node_modules\\jest-runner\\build\\runTest.js:444:34)"],"fullName":"ApiKeyGuard should throw ForbiddenException if account is suspended","invocations":1,"location":null,"numPassingAsserts":0,"retryReasons":[],"status":"failed","title":"should throw ForbiddenException if account is suspended"}],"endTime":1771659300345,"message":"  â— ApiKeyGuard â€º should allow request and update balance atomically\n\n    UnauthorizedException: Failed to authenticate API key\n\n    \u001b[0m \u001b[90m 325 |\u001b[39m\n     \u001b[90m 326 |\u001b[39m             \u001b[36mthis\u001b[39m\u001b[33m.\u001b[39mlogger\u001b[33m.\u001b[39merror(\u001b[32m'Authentication error:'\u001b[39m\u001b[33m,\u001b[39m error)\u001b[33m;\u001b[39m\n    \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 327 |\u001b[39m             \u001b[36mthrow\u001b[39m \u001b[36mnew\u001b[39m \u001b[33mUnauthorizedException\u001b[39m({\n     \u001b[90m     |\u001b[39m                   \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n     \u001b[90m 328 |\u001b[39m                 statusCode\u001b[33m:\u001b[39m \u001b[35m401\u001b[39m\u001b[33m,\u001b[39m\n     \u001b[90m 329 |\u001b[39m                 error\u001b[33m:\u001b[39m \u001b[32m'AUTHENTICATION_FAILED'\u001b[39m\u001b[33m,\u001b[39m\n     \u001b[90m 330 |\u001b[39m                 message\u001b[33m:\u001b[39m \u001b[32m'Failed to authenticate API key'\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\n\n      at ApiKeyGuard.canActivate (common/guards/api-key.guard.ts:327:19)\n      at Object.<anonymous> (common/guards/api-key.guard.spec.ts:134:24)\n\n  â— ApiKeyGuard â€º should throw ForbiddenException if account is suspended\n\n    expect(received).rejects.toThrow(expected)\n\n    Expected constructor: ForbiddenException\n    Received constructor: UnauthorizedException\n\n    Received message: \"Associated user account not found\"\n\n        \u001b[0m \u001b[90m 100 |\u001b[39m             \u001b[36mconst\u001b[39m user \u001b[33m=\u001b[39m dbKey\u001b[33m.\u001b[39muser\u001b[33m;\u001b[39m\n         \u001b[90m 101 |\u001b[39m             \u001b[36mif\u001b[39m (\u001b[33m!\u001b[39muser) {\n        \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 102 |\u001b[39m                 \u001b[36mthrow\u001b[39m \u001b[36mnew\u001b[39m \u001b[33mUnauthorizedException\u001b[39m({\n         \u001b[90m     |\u001b[39m                       \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n         \u001b[90m 103 |\u001b[39m                     statusCode\u001b[33m:\u001b[39m \u001b[35m401\u001b[39m\u001b[33m,\u001b[39m\n         \u001b[90m 104 |\u001b[39m                     error\u001b[33m:\u001b[39m \u001b[32m'USER_NOT_FOUND'\u001b[39m\u001b[33m,\u001b[39m\n         \u001b[90m 105 |\u001b[39m                     message\u001b[33m:\u001b[39m \u001b[32m'Associated user account not found'\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\n\n      at ApiKeyGuard.canActivate (common/guards/api-key.guard.ts:102:23)\n      at Object.<anonymous> (common/guards/api-key.guard.spec.ts:161:9)\n      at Object.toThrow (../node_modules/expect/build/index.js:218:22)\n      at Object.<anonymous> (common/guards/api-key.guard.spec.ts:161:58)\n","name":"C:\\Users\\Intel\\Desktop\\mumin\\api\\src\\common\\guards\\api-key.guard.spec.ts","startTime":1771659286943,"status":"failed","summary":""}],"wasInterrupted":false}
