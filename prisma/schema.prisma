generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextIndex", "fullTextSearch"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Collection {
  id          Int      @id @default(autoincrement())
  nameEnglish String   @map("name_english") @db.VarChar(100)
  nameArabic  String?  @map("name_arabic") @db.VarChar(100)
  slug        String   @unique @db.VarChar(50)
  description String?
  totalHadith Int      @default(0) @map("total_hadith")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  hadiths     Hadith[]

  @@map("collections")
}

model Hadith {
  id             Int           @id @default(autoincrement())
  collection     String        @db.VarChar(50)
  collectionId   Int?          @map("collection_id")
  bookNumber     Int           @map("book_number")
  hadithNumber   Int           @map("hadith_number")
  arabicText     String        @map("arabic_text")
  arabicNarrator String?       @map("arabic_narrator") @db.VarChar(255)
  metadata       Json?
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")
  collectionRef  Collection?   @relation(fields: [collectionId], references: [id])
  translations   Translation[]

  @@unique([collection, bookNumber, hadithNumber])
  @@index([collection])
  @@index([collectionId])
  @@index([bookNumber])
  @@map("hadiths")
}

model Translation {
  id           Int     @id @default(autoincrement())
  hadithId     Int     @map("hadith_id")
  languageCode String  @map("language_code") @db.VarChar(5)
  text         String
  narrator     String? @db.VarChar(255)
  grade        String? @db.VarChar(50)
  translator   String? @db.VarChar(100)
  hadith       Hadith  @relation(fields: [hadithId], references: [id], onDelete: Cascade)

  @@unique([hadithId, languageCode])
  @@index([languageCode])
  @@index([hadithId])
  @@map("translations")
}

model User {
  id                      Int                      @id @default(autoincrement())
  email                   String                   @unique @db.VarChar(255)
  password                String                   @db.VarChar(255)
  firstName               String?                  @map("first_name") @db.VarChar(100)
  lastName                String?                  @map("last_name") @db.VarChar(100)
  hashedRt                String?                  @map("hashed_rt")
  balance                 Int                      @default(0)
  totalRequests           Int                      @default(0) @map("total_requests")
  totalDataTransferred    BigInt                   @default(0) @map("total_data_transferred")
  createdAt               DateTime                 @default(now()) @map("created_at")
  updatedAt               DateTime                 @updatedAt @map("updated_at")
  cookieConsent           Json?                    @map("cookie_consent")
  emailVerified           Boolean                  @default(false) @map("email_verified")
  emailVerifiedAt         DateTime?                @map("email_verified_at")
  accountDeletionRequests AccountDeletionRequest[]
  apiKeys                 ApiKey[]
  dataExportRequests      DataExportRequest[]
  emailLogs               EmailLog[]
  fraudEvents             FraudEvent[]
  payments                Payment[]
  requestLogs             RequestLog[]
  transactions            Transaction[]
  verificationCodes       VerificationCode[]
  verificationLogs        VerificationLog[]

  @@map("users")
}

model VerificationCode {
  id          Int       @id @default(autoincrement())
  email       String    @db.VarChar(255)
  code        String    @db.VarChar(60)
  expiresAt   DateTime  @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  attempts    Int       @default(0)
  maxAttempts Int       @default(3) @map("max_attempts")
  usedAt      DateTime? @map("used_at")
  userId      Int?      @map("user_id")
  user        User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email, expiresAt])
  @@map("verification_codes")
}

model VerificationLog {
  id        Int      @id @default(autoincrement())
  email     String   @db.VarChar(255)
  action    String   @db.VarChar(50)
  ipAddress String?  @map("ip_address") @db.VarChar(45)
  userAgent String?  @map("user_agent")
  success   Boolean  @default(false)
  reason    String?
  createdAt DateTime @default(now()) @map("created_at")
  userId    Int?     @map("user_id")
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email, createdAt])
  @@index([ipAddress, createdAt])
  @@map("verification_logs")
}

model ApiKey {
  id                      Int                      @id @default(autoincrement())
  keyHash                 String                   @unique @map("key_hash") @db.VarChar(64)
  keyPrefix               String                   @map("key_prefix") @db.VarChar(20)
  userEmail               String?                  @map("user_email") @db.VarChar(255)
  userMetadata            Json?                    @map("user_metadata")
  isActive                Boolean                  @default(true) @map("is_active")
  suspendedAt             DateTime?                @map("suspended_at")
  suspendReason           String?                  @map("suspend_reason")
  createdAt               DateTime                 @default(now()) @map("created_at")
  lastUsedAt              DateTime?                @map("last_used_at")
  lastActivityDate        DateTime                 @default(now()) @map("last_activity_date")
  termsAcceptedAt         DateTime?                @map("terms_accepted_at")
  termsVersion            String?                  @map("terms_version") @db.VarChar(10)
  privacyPolicyAcceptedAt DateTime?                @map("privacy_policy_accepted_at")
  privacyPolicyVersion    String?                  @map("privacy_policy_version") @db.VarChar(10)
  cookieConsent           Json?                    @map("cookie_consent")
  ipAtRegistration        String?                  @map("ip_at_registration") @db.VarChar(45)
  userAgentAtRegistration String?                  @map("user_agent_at_registration")
  deviceFingerprintAtReg  String?                  @map("device_fingerprint_at_reg") @db.VarChar(64)
  geoLocationAtReg        String?                  @map("geo_location_at_reg") @db.VarChar(100)
  trustScore              Float                    @default(50) @map("trust_score")
  fraudFlags              String[]                 @default([]) @map("fraud_flags")
  maxDailyRequests        Int                      @default(500) @map("max_daily_requests")
  inactivityWarnings      Int                      @default(0) @map("inactivity_warnings")
  dormantAt               DateTime?                @map("dormant_at")
  allowedIPs              String[]                 @default([]) @map("allowed_ips")
  webhookUrl              String?                  @map("webhook_url") @db.VarChar(500)
  notes                   String?
  description             String?                  @map("description")
  allowedOrigins          String[]                 @default([]) @map("allowed_origins")
  userId                  Int                      @map("user_id")
  accountDeletionRequests AccountDeletionRequest[]
  user                    User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  dataExportRequests      DataExportRequest[]
  emailLogs               EmailLog[]
  fraudEvents             FraudEvent[]
  payments                Payment[]
  requestLogs             RequestLog[]
  transactions            Transaction[]

  @@index([keyHash])
  @@index([userEmail])
  @@index([isActive])
  @@index([createdAt])
  @@index([lastActivityDate])
  @@map("api_keys")
}

model RequestLog {
  id                Int      @id @default(autoincrement())
  apiKeyId          Int?     @map("api_key_id")
  endpoint          String
  method            String   @db.VarChar(10)
  requestBody       Json?    @map("request_body")
  requestHeaders    Json?    @map("request_headers")
  queryParams       Json?    @map("query_params")
  responseStatus    Int?     @map("response_status")
  responseBody      Json?    @map("response_body")
  responseTimeMs    Int?     @map("response_time_ms")
  dataTransferred   Int?     @map("data_transferred")
  ipAddress         String?  @map("ip_address") @db.VarChar(45)
  userAgent         String?  @map("user_agent")
  deviceFingerprint String?  @map("device_fingerprint") @db.VarChar(64)
  geoLocation       String?  @map("geo_location") @db.VarChar(100)
  wasFromCache      Boolean  @default(false) @map("was_from_cache")
  cacheKey          String?  @map("cache_key") @db.VarChar(255)
  billingImpact     Int      @default(1) @map("billing_impact")
  requestId         String   @map("request_id") @db.VarChar(36)
  timestamp         DateTime @default(now())
  userId            Int?     @map("user_id")
  apiKey            ApiKey?  @relation(fields: [apiKeyId], references: [id])
  user              User?    @relation(fields: [userId], references: [id])

  @@index([apiKeyId])
  @@index([timestamp(sort: Desc)])
  @@index([endpoint])
  @@index([ipAddress])
  @@index([requestId])
  @@map("request_logs")
}

model Transaction {
  id            Int      @id @default(autoincrement())
  apiKeyId      Int?     @map("api_key_id")
  type          String
  amount        Int
  balanceBefore Int      @map("balance_before")
  balanceAfter  Int      @map("balance_after")
  description   String?
  metadata      Json?
  paymentId     Int?     @map("payment_id")
  createdAt     DateTime @default(now()) @map("created_at")
  userId        Int      @map("user_id")
  apiKey        ApiKey?  @relation(fields: [apiKeyId], references: [id])
  payment       Payment? @relation(fields: [paymentId], references: [id])
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([apiKeyId])
  @@index([type])
  @@index([createdAt])
  @@map("transactions")
}

model Payment {
  id                 Int           @id @default(autoincrement())
  apiKeyId           Int?          @map("api_key_id")
  provider           String
  providerPaymentId  String        @unique @map("provider_payment_id")
  amount             Decimal       @db.Decimal(10, 2)
  currency           String        @default("USD") @db.VarChar(3)
  credits            Int
  status             String
  chargebackStatus   String?       @map("chargeback_status")
  chargebackReason   String?       @map("chargeback_reason")
  disputeEvidenceUrl String?       @map("dispute_evidence_url")
  metadata           Json?
  ipAddress          String?       @map("ip_address") @db.VarChar(45)
  deviceFingerprint  String?       @map("device_fingerprint") @db.VarChar(64)
  createdAt          DateTime      @default(now()) @map("created_at")
  completedAt        DateTime?     @map("completed_at")
  refundedAt         DateTime?     @map("refunded_at")
  userId             Int           @map("user_id")
  apiKey             ApiKey?       @relation(fields: [apiKeyId], references: [id])
  user               User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions       Transaction[]

  @@index([apiKeyId])
  @@index([provider])
  @@index([providerPaymentId])
  @@index([status])
  @@map("payments")
}

model EmailLog {
  id           Int       @id @default(autoincrement())
  apiKeyId     Int?      @map("api_key_id")
  emailType    String    @map("email_type")
  recipient    String    @db.VarChar(255)
  subject      String
  sentAt       DateTime  @default(now()) @map("sent_at")
  deliveredAt  DateTime? @map("delivered_at")
  openedAt     DateTime? @map("opened_at")
  clickedAt    DateTime? @map("clicked_at")
  bounced      Boolean   @default(false)
  bounceReason String?   @map("bounce_reason")
  messageId    String    @unique @map("message_id") @db.VarChar(255)
  provider     String    @default("resend")
  metadata     Json?
  userId       Int?      @map("user_id")
  apiKey       ApiKey?   @relation(fields: [apiKeyId], references: [id])
  user         User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([apiKeyId])
  @@index([emailType])
  @@index([sentAt])
  @@index([provider])
  @@map("email_logs")
}

model FraudEvent {
  id          Int      @id @default(autoincrement())
  apiKeyId    Int      @map("api_key_id")
  eventType   String   @map("event_type")
  severity    String
  description String
  evidence    Json?
  actionTaken String?  @map("action_taken")
  ipAddress   String?  @map("ip_address") @db.VarChar(45)
  timestamp   DateTime @default(now())
  userId      Int?     @map("user_id")
  apiKey      ApiKey   @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)
  user        User?    @relation(fields: [userId], references: [id])

  @@index([apiKeyId])
  @@index([eventType])
  @@index([severity])
  @@index([timestamp])
  @@map("fraud_events")
}

model AdminAuditLog {
  id          Int      @id @default(autoincrement())
  adminKeyId  Int      @map("admin_key_id")
  action      String
  targetKeyId Int?     @map("target_key_id")
  details     Json?
  ipAddress   String?  @map("ip_address") @db.VarChar(45)
  timestamp   DateTime @default(now())

  @@index([adminKeyId])
  @@index([targetKeyId])
  @@index([timestamp])
  @@map("admin_audit_logs")
}

model DataExportRequest {
  id          Int       @id @default(autoincrement())
  apiKeyId    Int?      @map("api_key_id")
  status      String    @default("pending")
  requestedAt DateTime  @default(now()) @map("requested_at")
  completedAt DateTime? @map("completed_at")
  downloadUrl String?   @map("download_url")
  expiresAt   DateTime? @map("expires_at")
  fileSize    Int?      @map("file_size")
  format      String    @default("json")
  userId      Int       @map("user_id")
  apiKey      ApiKey?   @relation(fields: [apiKeyId], references: [id])
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([apiKeyId])
  @@index([status])
  @@map("data_export_requests")
}

model AccountDeletionRequest {
  id                Int       @id @default(autoincrement())
  apiKeyId          Int?      @map("api_key_id")
  requestedAt       DateTime  @default(now()) @map("requested_at")
  scheduledFor      DateTime  @map("scheduled_for")
  confirmationToken String    @unique @map("confirmation_token") @db.VarChar(64)
  confirmed         Boolean   @default(false)
  confirmedAt       DateTime? @map("confirmed_at")
  deletedAt         DateTime? @map("deleted_at")
  reason            String?
  userId            Int       @map("user_id")
  apiKey            ApiKey?   @relation(fields: [apiKeyId], references: [id])
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([apiKeyId])
  @@index([scheduledFor])
  @@map("account_deletion_requests")
}

model EndpointStats {
  id            Int      @id @default(autoincrement())
  date          DateTime @db.Date
  endpoint      String   @db.VarChar(255)
  totalHits     Int      @default(0) @map("total_hits")
  uniqueUsers   Int      @default(0) @map("unique_users")
  avgResponseMs Float    @default(0) @map("avg_response_ms")
  cacheHitRate  Float    @default(0) @map("cache_hit_rate")

  @@unique([date, endpoint])
  @@index([date])
  @@map("endpoint_stats")
}

model GeoStats {
  id           Int      @id @default(autoincrement())
  date         DateTime @db.Date
  country      String   @db.VarChar(2)
  requestCount Int      @default(0) @map("request_count")
  uniqueUsers  Int      @default(0) @map("unique_users")

  @@unique([date, country])
  @@index([date])
  @@map("geo_stats")
}
